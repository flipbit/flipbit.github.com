---
layout: post
title: Unit Testing Session in an ASP.NET MVC Controller
title_short: Unit Testing Session in an ASP.NET MVC Controller
pretty_date: Thursday, 6 November 2008
---
<p>I’ve recently started to use the <a href="http://www.asp.net/mvc/" title="Microsoft ASP.NET MVC Framework">Microsoft ASP.NET MVC</a> framework.  Being very familiar with the <a href="http://www.castleproject.org/MonoRail/" title="Castle Project Monorail Framework">Castle Monorail</a>, I was a bit dubious to how the Microsoft framework would hold up.<br />
</p><p>One of the first tasks I had difficulty with was writing a basic unit test to see whether a user was logged in, through holding their credentials in session:<br />
</p><pre name="code" class="csharp:nocontrols">using NUnit.Framework;

    [TestFixture]
    public class HomeControllerTest
    {
        private HomeController controller;

        [Test]
        public void TestIndexAction()
        {
            controller = new HomeController();

            // Display the homepage
            controller.Index();

            // Verify the user object hasn't been set in session
            Assert.IsNull(controller.ControllerContext.HttpContext.Session["user"]);
        }
    }
</pre><p>When I can to run this test, it failed as the HttpContextSessionBase class hadn’t been instantiated.  After googling this, <a title="Eilon Lipton's Blog" href="http://weblogs.asp.net/leftslipper/archive/2008/04/13/mvc-unit-testing-controller-actions-that-use-tempdata.aspx">several</a> <a href="http://weblogs.asp.net/stephenwalther/archive/2008/06/30/asp-net-mvc-tip-12-faking-the-controller-context.aspx" title ="Stephen Walther on ASP.NET MVC">blogs</a> had described the same issue; however I couldn’t find an answer without manually Mocking or creating Fakes.  Monorail conversely, has the solution is built into the framework:<br />
</p><pre name="code" class="csharp:nocontrols">[TestFixture]
    class HomeControllerTest : BaseControllerTest
    {
        private HomeController controller;

        [SetUp]
        public void SetUp()
        {
            controller = new HomeController();

            PrepareController(controller);
        }

        [Test]
        public void TestIndexAction()
        {
            // Display homepage
            controller.Index();

            // Verify the user object hasn't been set in session
            Assert.IsNull(controller.Context.Session["user"]);
        }
    }
</pre><p>After further research, I came across the <a href="http://www.codeplex.com/MVCContrib" title="ASP.NET MVC Contrib Project Homepage">MVC Contrib Project</a> on Codeplex.  Adding references to their testing assembly I was able to write the following:<br />
</p><pre name="code" class="csharp:nocontrols">using MvcContrib.TestHelper;
    using NUnit.Framework;

    [TestFixture]
    public class HomeControllerTest
    {
        private HomeController controller;
        private TestControllerBuilder builder;

        [SetUp]
        public void SetUp()
        {
            builder = new TestControllerBuilder();

            controller = new HomeController();

            builder.InitializeController(controller);
        }

        [Test]
        public void TestIndexAction()
        {
            // Display the homepage
            controller.Index();

            // Verify the user object hasn't been set in session
            Assert.IsNull(controller.ControllerContext.HttpContext.Session["user"]);
        }
    }
</pre><p>In order to run it requires a reference to <a href="http://ayende.com/projects/rhino-mocks.aspx">Rhino.Mocks</a>, so I guess under the hood this is what it's using.<br />
</p><p>It would be good if this kind of testing simplicity was baked into the framework, as in Monorail, but it seems ASP.NET MVC still has some way to go to escape the burden of the sealed ASP.NET HttpContext classes.  <br />
</p>